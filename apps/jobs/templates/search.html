{% extends 'base.html' %}

{% block title %}Search{% endblock %}

{% block content %}
<div id="search-app" class="container mx-auto px-4">
    <h1 class="text-3xl font-bold mb-4">Search</h1>

    <form id="search-form" class="mb-4">
        <div class="flex items-center space-x-2">
            <div class="w-1/2">
                <label for="query" class="block text-sm font-medium text-gray-700">Query</label>
                <input id="query" name="query" type="text" required
                    class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
            </div>

            <div class="w-1/2">
                <label for="company_size" class="block text-sm font-medium text-gray-700">Company Size</label>
                <select id="company_size" name="company_size"
                        class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                    <option value="" selected>All</option>
                    <option value="size_1-9">1-9</option>
                    <option value="size_10-49">10-49</option>
                    <option value="size_50-99">50-99</option>
                    <option value="size_100">100+</option>
                </select>
            </div>
        </div>

        <div class="mt-4">
            <button type="submit"
                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Search
            </button>
        </div>
    </form>

    <div id="job-results" class="mt-8"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('search-form').addEventListener('submit', function(event) {
        event.preventDefault();
        performSearch();
    });

    function performSearch() {
        var query = document.getElementById('query').value.trim();
        var companySize = document.getElementById('company_size').value.trim();

        if (!query) {
            alert('Please enter a search query.');
            return;
        }

        var data = {
            'query': query,
            'company_size': companySize
        }

        fetch('api/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(function(response) {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(function(result) {
            console.log('Success', result.jobs);
            displayJobs(result.jobs);
        })
        .catch(function(error) {
            console.error('Error', error);
            alert('An error occurred while performing the search.');
        });
    }

    function displayJobs(jobs) {
        var jobResults = document.getElementById('job-results');
        jobResults.innerHTML = '';
        jobs.forEach(function(job) {
            var div = document.createElement('div');
            div.classList.add('notification', 'mt-2');

            var h3 = document.createElement('h3');
            h3.classList.add('text-lg', 'font-bold');
            h3.textContent = job.title;

            var p = document.createElement('p');
            p.textContent = job.company_name;

            var a = document.createElement('a');
            a.setAttribute('href', job.url);
            a.textContent = 'View Details';

            div.appendChild(h3);
            div.appendChild(p);
            div.appendChild(a);

            jobResults.appendChild(div);
        });
    }

    // Function to get CSRF token from cookie
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
